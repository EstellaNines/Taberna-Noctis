# æ¯æ—¥ä¿¡æ¯ç³»ç»Ÿ - å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•

## åŠŸèƒ½ç»¼è¿°

æ¯æ—¥ä¿¡æ¯ç³»ç»Ÿåœ¨æ¯ä¸ªæ¸¸æˆæ—¥å¼€åœºä»¥ DOTween æŠ¥çº¸ç¿»é¡µåŠ¨ç”»å‘ˆç°å½“æ—¥æ¶ˆæ¯ï¼Œæ”¯æŒæ¥è‡ª JSON æˆ– SO çš„æ•°æ®æºä¸å¥å£®çš„å›é€€åŠ è½½ç­–ç•¥ï¼Œå¹¶å¯æŒ‰éœ€é€‰æ‹©â€œç§å­éšæœºâ€æˆ–â€œçœŸéšæœºâ€æ¨¡å¼ï¼›åœ¨ç”Ÿæˆè§†å›¾å¹¶åº”ç”¨å›¾ç‰‡å›é€€åï¼Œä¼šé€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå¹¿æ’­å½“æ—¥äº‹ä»¶å½±å“ï¼Œé©±åŠ¨å…¶ä»–æ¨¡å—è¿›è¡Œç›¸åº”çš„æ•°å€¼æˆ–å±•ç¤ºæ›´æ–°ã€‚

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [ç±»å›¾](#ç±»å›¾)
- [æ•°æ®æ¨¡å‹ ER å›¾](#æ•°æ®æ¨¡å‹erå›¾)
- [æ—¶åºå›¾](#æ—¶åºå›¾)
- [æ ¸å¿ƒç»„ä»¶è¯´æ˜](#æ ¸å¿ƒç»„ä»¶è¯´æ˜)
- [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [é…ç½®æŒ‡å—](#é…ç½®æŒ‡å—)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ç³»ç»Ÿæ¦‚è¿°

**æ¯æ—¥ä¿¡æ¯ç³»ç»Ÿ**ï¼ˆDaily Message Systemï¼‰æ˜¯ Taberna-Noctis æ¸¸æˆä¸­çš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼Œè´Ÿè´£åœ¨æ¯ä¸ªæ¸¸æˆæ—¥å¼€å§‹æ—¶å‘ç©å®¶å±•ç¤ºå½“æ—¥çš„æ–°é—»äº‹ä»¶ã€‚è¯¥ç³»ç»Ÿé€šè¿‡åŠ¨æ€æŠ¥çº¸ç¿»é¡µåŠ¨ç”»å‘ˆç°è§†è§‰æ•ˆæœï¼Œå¹¶å°†äº‹ä»¶å½±å“åº”ç”¨åˆ°æ¸¸æˆçŠ¶æ€ä¸­ã€‚

### ä¸»è¦åŠŸèƒ½

- ğŸ“° **æŠ¥çº¸åŠ¨ç”»å±•ç¤º**ï¼šé€šè¿‡ DOTween å®ç°é¡ºåºæ¸å…¥çš„æŠ¥çº¸ç¿»é¡µæ•ˆæœ
- ğŸ“Š **æ•°æ®é©±åŠ¨**ï¼šä» JSON é…ç½®æ–‡ä»¶åŠ è½½æ¯æ—¥æ¶ˆæ¯æ•°æ®
- ğŸ² **éšæœºäº‹ä»¶**ï¼šæ”¯æŒç§å­éšæœºæˆ–çœŸéšæœºé€‰æ‹©æ¯æ—¥äº‹ä»¶
- ğŸ“¡ **çŠ¶æ€å¹¿æ’­**ï¼šé€šè¿‡æ¶ˆæ¯ç³»ç»Ÿå°†äº‹ä»¶å½±å“å¹¿æ’­åˆ°æ¸¸æˆå…¶ä»–æ¨¡å—
- ğŸ–¼ï¸ **åŠ¨æ€ UI**ï¼šè¿è¡Œæ—¶ç”Ÿæˆå’Œæ˜¾ç¤ºæ¯æ—¥æ¶ˆæ¯è§†å›¾

### æŠ€æœ¯æ ˆ

- **Unity Engine**ï¼šæ¸¸æˆå¼•æ“
- **DOTween**ï¼šåŠ¨ç”»è¡¥é—´å¼•æ“
- **ScriptableObject**ï¼šæ•°æ®é…ç½®ç³»ç»Ÿ
- **MessageManager**ï¼šäº‹ä»¶é€šä¿¡ç³»ç»Ÿ
- **Resources ç³»ç»Ÿ**ï¼šèµ„æºåŠ è½½

---

## æ¶æ„è®¾è®¡

### è®¾è®¡æ¨¡å¼

ç³»ç»Ÿé‡‡ç”¨ä»¥ä¸‹è®¾è®¡æ¨¡å¼ï¼š

1. **MVC æ¨¡å¼**

   - **Model**ï¼š`DailyMessagesData` - æ•°æ®æ¨¡å‹å’Œä¸šåŠ¡é€»è¾‘
   - **View**ï¼š`DailyMessageView` - UI è§†å›¾ç»„ä»¶
   - **Controller**ï¼š`NewspaperAnimationController` - æ§åˆ¶å™¨å’ŒåŠ¨ç”»é€»è¾‘

2. **å•ä¸€èŒè´£åŸåˆ™**

   - æ•°æ®åŠ è½½ï¼š`DailyMessagesData`
   - UI å±•ç¤ºï¼š`DailyMessageView`
   - åŠ¨ç”»æ§åˆ¶ï¼š`NewspaperAnimationController`

3. **è§‚å¯Ÿè€…æ¨¡å¼**
   - é€šè¿‡`MessageManager`å®ç°äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœºåˆ¶

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DailyMessage Scene                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NewspaperAnimationController        â”‚  â”‚
â”‚  â”‚  (æ§åˆ¶å™¨ + åŠ¨ç”»ç¼–æ’)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚        â”‚                 â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ DOTween   â”‚    â”‚ DailyMessages  â”‚       â”‚
â”‚  â”‚ Sequence  â”‚    â”‚ Data (SO)      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                             â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DailyMessageView (åŠ¨æ€å®ä¾‹åŒ–)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MessageManager (äº‹ä»¶å¹¿æ’­)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç±»å›¾

```mermaid
classDiagram
    class DailyMessagesData {
        <<ScriptableObject>>
        +string jsonResourcePath
        +List~Entry~ messagesInSO
        -Root _cache
        +Root Load()
        +Entry GetRandomEntry(int? seed)
    }

    class Root {
        +int version
        +List~Entry~ messages
    }

    class Entry {
        +string id
        +string title
        +string imagePath
        +List~Adjustment~ adjustments
    }

    class Adjustment {
        +string identity
        +string state
        +string gender
        +string npcId
        +float deltaPercent
    }

    class DailyMessageApplied {
        <<struct>>
        +string id
        +string title
        +string imagePath
        +List~Adjustment~ adjustments
    }

    class NewspaperAnimationController {
        <<MonoBehaviour>>
        -List~Image~ newspaperImages
        -float delayBetweenPages
        -float fadeInDuration
        -bool playOnStart
        -DailyMessageView dailyMessagePrefab
        -Transform dailyMessageParent
        -DailyMessagesData dailyMessagesData
        -Sequence _animationSequence
        +void PlayAnimation()
        +void StopAnimation()
        +void ResetNewspapers()
        -void InitializeNewspapers()
        -Sprite LoadSpriteWithFallback(string path)
    }

    class DailyMessageView {
        <<MonoBehaviour>>
        -Image targetImage
        +void SetSprite(Sprite sprite, bool setNativeSize)
        +Image GetImage()
    }

    DailyMessagesData "1" --> "1" Root : contains
    Root "1" --> "*" Entry : contains
    Entry "1" --> "*" Adjustment : contains
    DailyMessagesData ..> DailyMessageApplied : creates
    NewspaperAnimationController "1" --> "1" DailyMessagesData : uses
    NewspaperAnimationController "1" --> "1" DailyMessageView : instantiates
    NewspaperAnimationController ..> DailyMessageApplied : broadcasts
```

---

## æ•°æ®æ¨¡å‹ ER å›¾

```mermaid
erDiagram
    ROOT ||--o{ ENTRY : contains
    ENTRY ||--o{ ADJUSTMENT : contains

    ROOT {
        int version "æ•°æ®ç‰ˆæœ¬å·"
        array messages "æ¶ˆæ¯åˆ—è¡¨"
    }

    ENTRY {
        string id "å”¯ä¸€æ ‡è¯†ç¬¦"
        string title "æ¶ˆæ¯æ ‡é¢˜"
        string imagePath "å›¾ç‰‡èµ„æºè·¯å¾„"
        array adjustments "çŠ¶æ€è°ƒæ•´åˆ—è¡¨"
    }

    ADJUSTMENT {
        string identity "èº«ä»½ç±»å‹"
        string state "çŠ¶æ€ç±»å‹"
        string gender "æ€§åˆ«(male/female/any)"
        string npcId "NPCæ ‡è¯†(å¯é€‰)"
        float deltaPercent "ç™¾åˆ†æ¯”å˜åŒ–å€¼"
    }

    DAILY_MESSAGE_APPLIED {
        string id "æ¶ˆæ¯ID"
        string title "æ¶ˆæ¯æ ‡é¢˜"
        string imagePath "å›¾ç‰‡è·¯å¾„"
        array adjustments "è°ƒæ•´æ•°æ®"
    }

    ENTRY ||--|| DAILY_MESSAGE_APPLIED : transforms_to
```

### æ•°æ®å…³ç³»è¯´æ˜

1. **ROOT** - æ ¹æ•°æ®ç»“æ„

   - åŒ…å«ç‰ˆæœ¬å·å’Œæ¶ˆæ¯åˆ—è¡¨
   - ä» JSON æ–‡ä»¶åŠ è½½

2. **ENTRY** - æ¶ˆæ¯æ¡ç›®

   - æ¯ä¸ªæ¡ç›®ä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„æ¯æ—¥äº‹ä»¶
   - åŒ…å«æ˜¾ç¤ºä¿¡æ¯ï¼ˆæ ‡é¢˜ã€å›¾ç‰‡ï¼‰å’Œæ¸¸æˆå½±å“ï¼ˆadjustmentsï¼‰

3. **ADJUSTMENT** - çŠ¶æ€è°ƒæ•´

   - å®šä¹‰äº‹ä»¶å¯¹æ¸¸æˆçŠ¶æ€çš„å…·ä½“å½±å“
   - æ”¯æŒæŒ‰èº«ä»½ã€çŠ¶æ€ã€æ€§åˆ«ã€NPC ç­›é€‰
   - deltaPercent ä¸ºæ­£å€¼å¢åŠ ï¼Œè´Ÿå€¼å‡å°‘

4. **DAILY_MESSAGE_APPLIED** - åº”ç”¨çš„æ¶ˆæ¯
   - Entry çš„è¿è¡Œæ—¶è¡¨ç°å½¢å¼
   - é€šè¿‡ MessageManager å¹¿æ’­åˆ°å…¶ä»–ç³»ç»Ÿ

---

## æ—¶åºå›¾

### 1. ç³»ç»Ÿåˆå§‹åŒ–ä¸æ¶ˆæ¯æ˜¾ç¤ºæµç¨‹

```mermaid
sequenceDiagram
    participant Scene as DayMessageScreen
    participant Controller as NewspaperAnimationController
    participant Data as DailyMessagesData
    participant Resources as Resources System
    participant DOTween as DOTween Engine
    participant View as DailyMessageView
    participant MsgMgr as MessageManager

    Scene->>Controller: Start()
    activate Controller

    alt playOnStart == true
        Controller->>Controller: PlayAnimation()
        Controller->>Controller: StopAnimation()
        Controller->>Controller: InitializeNewspapers()

        loop åˆå§‹åŒ–æŠ¥çº¸åˆ—è¡¨
            Controller->>Controller: GetOrAddCanvasGroup()
            Controller->>Controller: Set alpha = 0
            Controller->>Controller: SetActive(false)
        end

        Controller->>DOTween: DOTween.Sequence()
        activate DOTween
        DOTween-->>Controller: Sequenceå®ä¾‹

        loop æ¯å¼ æŠ¥çº¸ (i = 0 to count-1)
            Controller->>DOTween: InsertCallback(delay, SetActive)
            Controller->>DOTween: Insert(delay, DOFade(1, duration))
        end

        alt enableDailyMessage == true
            Note over Controller: åœ¨ç¬¬4å¼ æŠ¥çº¸åè§¦å‘
            Controller->>DOTween: InsertCallback(callbackDelay, callback)

            DOTween->>Controller: [å›è°ƒè§¦å‘]
            Controller->>View: Instantiate(dailyMessagePrefab)
            activate View

            Controller->>Data: GetRandomEntry(seed?)
            activate Data

            alt ä¼˜å…ˆä½¿ç”¨SOæ•°æ®
                Data-->>Controller: messagesInSO[random]
            else ä»JSONåŠ è½½
                Data->>Resources: Load<TextAsset>(jsonPath)
                Resources-->>Data: TextAsset
                Data->>Data: JsonUtility.FromJson<Root>()
                Data->>Data: Cache result
                Data-->>Controller: _cache.messages[random]
            end
            deactivate Data

            Controller->>Resources: LoadSpriteWithFallback(imagePath)
            Resources-->>Controller: Sprite
            Controller->>View: SetSprite(sprite)
            View->>View: targetImage.sprite = sprite

            loop æ¯ä¸ªAdjustment
                Controller->>Controller: è®¡ç®—çŠ¶æ€å˜åŒ–
                Controller->>Controller: Debug.Log(è°ƒæ•´è¯¦æƒ…)
            end

            Controller->>Controller: åˆ›å»ºDailyMessageApplied
            Controller->>MsgMgr: Send(DailyMessageApplied)
            activate MsgMgr
            MsgMgr-->>MsgMgr: å¹¿æ’­åˆ°è®¢é˜…è€…
            deactivate MsgMgr

            deactivate View
        end

        Controller->>DOTween: Play()
        DOTween-->>DOTween: æ‰§è¡ŒåŠ¨ç”»åºåˆ—
        deactivate DOTween
    end

    deactivate Controller
```

### 2. æ•°æ®åŠ è½½è¯¦ç»†æµç¨‹

```mermaid
sequenceDiagram
    participant Controller as NewspaperAnimationController
    participant Data as DailyMessagesData
    participant Resources as Resources
    participant Cache as _cache

    Controller->>Data: GetRandomEntry(seed?)
    activate Data

    alt messagesInSOå­˜åœ¨ä¸”æœ‰æ•°æ®
        Data-->>Data: source = messagesInSO
    else éœ€è¦ä»JSONåŠ è½½
        Data->>Data: Load()

        alt _cacheå·²å­˜åœ¨
            Data-->>Data: return _cache
        else é¦–æ¬¡åŠ è½½
            Data->>Resources: Load<TextAsset>(jsonResourcePath)

            alt æ‰¾åˆ°èµ„æº
                Resources-->>Data: TextAsset
            else èµ„æºä¸å­˜åœ¨
                Data->>Resources: Load<TextAsset>(fallback path)
                alt æ‰¾åˆ°å¤‡ç”¨èµ„æº
                    Resources-->>Data: TextAsset
                else å®Œå…¨å¤±è´¥
                    Resources-->>Data: null
                    Data-->>Controller: ç©ºRootå¯¹è±¡
                end
            end

            alt TextAssetæœ‰æ•ˆ
                Data->>Data: JsonUtility.FromJson<Root>(text)
                Data->>Cache: å­˜å‚¨åˆ°_cache
                Cache-->>Data: Rootå¯¹è±¡
            else è§£æå¤±è´¥
                Data-->>Data: åˆ›å»ºç©ºRoot
            end
        end

        Data-->>Data: source = _cache.messages
    end

    alt seedæœ‰å€¼
        Data->>Data: Random rng = new Random(seed)
        Data->>Data: idx = rng.Next(0, count)
    else ä½¿ç”¨Unityéšæœº
        Data->>Data: idx = Random.Range(0, count)
    end

    Data->>Data: Clamp(idx, 0, count-1)
    Data-->>Controller: Entryå¯¹è±¡
    deactivate Data
```

### 3. å›¾ç‰‡èµ„æºåŠ è½½å›é€€æœºåˆ¶

```mermaid
sequenceDiagram
    participant Controller as NewspaperAnimationController
    participant Resources as Resources System

    Controller->>Resources: LoadSpriteWithFallback(path)
    activate Controller

    Resources->>Resources: Load<Sprite>(åŸå§‹è·¯å¾„)

    alt åŠ è½½æˆåŠŸ
        Resources-->>Controller: Spriteå¯¹è±¡
    else åŠ è½½å¤±è´¥
        Note over Resources: å°è¯•é›¶å¡«å……å˜ä½“

        Resources->>Resources: æŸ¥æ‰¾æœ€åçš„ä¸‹åˆ’çº¿ä½ç½®

        alt è·¯å¾„æ ¼å¼: xxx_0d
            Resources->>Resources: ç§»é™¤å‰å¯¼0
            Resources->>Resources: Load<Sprite>(xxx_d)

            alt åŠ è½½æˆåŠŸ
                Resources-->>Controller: Spriteå¯¹è±¡
            else ç»§ç»­å¤±è´¥
                Resources->>Resources: å°è¯•å…¶ä»–å˜ä½“
            end
        end

        alt è·¯å¾„æ ¼å¼: xxx_d (d<10)
            Resources->>Resources: æ·»åŠ å‰å¯¼0
            Resources->>Resources: Load<Sprite>(xxx_0d)

            alt åŠ è½½æˆåŠŸ
                Resources-->>Controller: Spriteå¯¹è±¡
            else å®Œå…¨å¤±è´¥
                Resources->>Resources: Debug.LogWarning
                Resources-->>Controller: null
            end
        end
    end

    deactivate Controller
```

---

## æ ¸å¿ƒç»„ä»¶è¯´æ˜

### 1. DailyMessagesData (ScriptableObject)

**èŒè´£**ï¼šæ•°æ®ç®¡ç†å’ŒåŠ è½½

#### æ ¸å¿ƒå­—æ®µ

```csharp
// èµ„æºè·¯å¾„é…ç½®
[Header("Source JSON (Resources)")]
public string jsonResourcePath = "DailyMessage/DailyMessages"; // ä¸å«.jsonæ‰©å±•å

// å¯é€‰çš„ç›´æ¥æ•°æ®å­˜å‚¨
[Header("Data (filled from JSON)")]
public List<Entry> messagesInSO = new List<Entry>();

// å†…éƒ¨ç¼“å­˜
private Root _cache;
```

#### æ ¸å¿ƒæ–¹æ³•

**Load() - åŠ è½½æ•°æ®**

- ä» Resources åŠ è½½ JSON æ–‡ä»¶
- ä½¿ç”¨ JsonUtility ååºåˆ—åŒ–
- å®ç°ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åŠ è½½
- æ”¯æŒå›é€€è·¯å¾„

**GetRandomEntry(int? seed) - è·å–éšæœºæ¡ç›®**

- ä¼˜å…ˆä½¿ç”¨`messagesInSO`ä¸­çš„æ•°æ®
- æ”¯æŒç§å­éšæœºï¼ˆå¯å¤ç°ï¼‰
- æ”¯æŒ Unity çœŸéšæœº
- è¿”å›éšæœºé€‰æ‹©çš„ Entry

#### æ•°æ®ç»“æ„

```csharp
[Serializable]
public class Root
{
    public int version;              // æ•°æ®ç‰ˆæœ¬å·
    public List<Entry> messages;     // æ¶ˆæ¯åˆ—è¡¨
}

[Serializable]
public class Entry
{
    public string id;                          // å”¯ä¸€æ ‡è¯†
    public string title;                       // æ ‡é¢˜
    public string imagePath;                   // å›¾ç‰‡è·¯å¾„ (Resources)
    public List<Adjustment> adjustments;       // çŠ¶æ€è°ƒæ•´åˆ—è¡¨
}

[Serializable]
public class Adjustment
{
    public string identity;          // èº«ä»½ (å¦‚: worker, noble)
    public string state;            // çŠ¶æ€ (å¦‚: happiness, health)
    public string gender;           // æ€§åˆ« (male/female/any)
    public string npcId;            // NPC ID (å¯é€‰)
    public float deltaPercent;      // ç™¾åˆ†æ¯”å˜åŒ– (+/-)
}

[Serializable]
public struct DailyMessageApplied
{
    public string id;
    public string title;
    public string imagePath;
    public List<Adjustment> adjustments;
}
```

---

### 2. NewspaperAnimationController (MonoBehaviour)

**èŒè´£**ï¼šåŠ¨ç”»æ§åˆ¶å’Œæ¶ˆæ¯ç”Ÿæˆ

#### é…ç½®å‚æ•°

```csharp
[Title("æŠ¥çº¸å›¾ç‰‡é…ç½®")]
[SerializeField] private List<Image> newspaperImages;  // æŠ¥çº¸å›¾ç‰‡åˆ—è¡¨

[Title("æ˜¾ç¤ºé…ç½®")]
[SerializeField] private float delayBetweenPages = 0.3f;     // é¡µé¢é—´å»¶è¿Ÿ
[SerializeField] private float fadeInDuration = 0.5f;        // æ·¡å…¥æ—¶é•¿
[SerializeField] private bool playOnStart = true;            // è‡ªåŠ¨æ’­æ”¾
[SerializeField] private Ease fadeEase = Ease.OutQuad;       // ç¼“åŠ¨æ›²çº¿

[Title("æ¯æ—¥æ¶ˆæ¯é¢„åˆ¶ä»¶")]
[SerializeField] private DailyMessageView dailyMessagePrefab;
[SerializeField] private Transform dailyMessageParent;
[SerializeField] private DailyMessagesData dailyMessagesData;
[SerializeField] private bool enableDailyMessage = false;
[SerializeField] private bool useSeed = false;
[SerializeField] private int seed = 0;
```

#### æ ¸å¿ƒæ–¹æ³•

**PlayAnimation() - æ’­æ”¾åŠ¨ç”»**

1. åœæ­¢ç°æœ‰åŠ¨ç”»
2. åˆå§‹åŒ–æ‰€æœ‰æŠ¥çº¸ä¸ºä¸å¯è§
3. åˆ›å»º DOTween Sequence
4. ä¸ºæ¯å¼ æŠ¥çº¸æ·»åŠ æ·¡å…¥åŠ¨ç”»ï¼ˆå»¶è¿Ÿé€’å¢ï¼‰
5. åœ¨ç¬¬ 4 å¼ æŠ¥çº¸åç”Ÿæˆæ¯æ—¥æ¶ˆæ¯
6. åŠ è½½å›¾ç‰‡å¹¶è®¾ç½®åˆ° View
7. å¹¿æ’­æ¶ˆæ¯å½±å“

**LoadSpriteWithFallback(string path) - å›¾ç‰‡åŠ è½½å›é€€**

- å°è¯•åŠ è½½åŸå§‹è·¯å¾„
- æ”¯æŒ `_0d` â†” `_d` æ ¼å¼äº’æ¢
- å¤„ç†é›¶å¡«å……çš„æ•°å­—åç¼€

**InitializeNewspapers() - åˆå§‹åŒ–æŠ¥çº¸**

- ä¸ºæ¯å¼ æŠ¥çº¸æ·»åŠ  CanvasGroup
- è®¾ç½® alpha ä¸º 0
- ç¦ç”¨ GameObject

---

### 3. DailyMessageView (MonoBehaviour)

**èŒè´£**ï¼šUI è§†å›¾å±•ç¤º

#### æ ¸å¿ƒå®ç°

```csharp
public class DailyMessageView : MonoBehaviour
{
    [SerializeField] private Image targetImage;

    public void SetSprite(Sprite sprite, bool setNativeSize = false)
    {
        if (targetImage == null) return;
        targetImage.sprite = sprite;
        if (setNativeSize && sprite != null)
            targetImage.SetNativeSize();
        if (!targetImage.gameObject.activeSelf)
            targetImage.gameObject.SetActive(true);
    }

    public Image GetImage() => targetImage;
}
```

**ç‰¹ç‚¹**ï¼š

- ç®€å•è½»é‡çš„è§†å›¾ç»„ä»¶
- ä»…è´Ÿè´£ UI å±•ç¤º
- ç”± Controller åŠ¨æ€å®ä¾‹åŒ–
- æ”¯æŒåŸå§‹å°ºå¯¸è®¾ç½®

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šDOTween åŠ¨ç”»åºåˆ—æ„å»º

```csharp
// åˆ›å»ºåŠ¨ç”»åºåˆ—
_animationSequence = DOTween.Sequence();

for (int i = 0; i < newspaperImages.Count; i++)
{
    Image newspaper = newspaperImages[i];
    if (newspaper == null) continue;

    // è®¡ç®—å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯å¼ æŠ¥çº¸é€’å¢ï¼‰
    float delay = i * delayBetweenPages;

    // è·å–æˆ–æ·»åŠ CanvasGroup
    CanvasGroup canvasGroup = GetOrAddCanvasGroup(newspaper);
    canvasGroup.alpha = 0;

    // æ•è·å˜é‡é¿å…é—­åŒ…é—®é¢˜
    Image capturedNewspaper = newspaper;
    CanvasGroup capturedGroup = canvasGroup;

    // åœ¨æŒ‡å®šæ—¶é—´æ¿€æ´»GameObject
    _animationSequence.InsertCallback(delay, () =>
    {
        if (capturedNewspaper != null)
        {
            capturedNewspaper.gameObject.SetActive(true);
        }
    });

    // æ’å…¥æ·¡å…¥åŠ¨ç”»
    _animationSequence.Insert(delay,
        capturedGroup.DOFade(1f, fadeInDuration).SetEase(fadeEase));
}

// æ’­æ”¾åºåˆ—
_animationSequence.Play();
```

**å…³é”®ç‚¹**ï¼š

- ä½¿ç”¨`Insert()`åœ¨ç‰¹å®šæ—¶é—´æ’å…¥åŠ¨ç”»
- ä½¿ç”¨`InsertCallback()`åœ¨ç‰¹å®šæ—¶é—´æ‰§è¡Œå›è°ƒ
- æ•è·å¾ªç¯å˜é‡é¿å…é—­åŒ…é™·é˜±
- ä½¿ç”¨`SetEase()`è®¾ç½®ç¼“åŠ¨æ•ˆæœ

---

### ç¤ºä¾‹ 2ï¼šéšæœºæ¶ˆæ¯è·å–

```csharp
public Entry GetRandomEntry(int? seed = null)
{
    // ä¼˜å…ˆä½¿ç”¨SOä¸­çš„æ•°æ®
    List<Entry> source = (messagesInSO != null && messagesInSO.Count > 0)
        ? messagesInSO
        : null;

    // å¦‚æœSOæ— æ•°æ®ï¼Œä»JSONåŠ è½½
    if (source == null)
    {
        var root = Load();
        if (root.messages == null || root.messages.Count == 0)
            return null;
        source = root.messages;
    }

    // æ ¹æ®æ˜¯å¦æœ‰ç§å­é€‰æ‹©éšæœºæ–¹å¼
    if (seed.HasValue)
    {
        // å¯å¤ç°çš„éšæœº
        var rng = new System.Random(seed.Value);
        int idx = rng.Next(0, source.Count);
        return source[Mathf.Clamp(idx, 0, source.Count - 1)];
    }
    else
    {
        // UnityçœŸéšæœº
        int idx = UnityEngine.Random.Range(0, source.Count);
        return source[Mathf.Clamp(idx, 0, source.Count - 1)];
    }
}
```

**å…³é”®ç‚¹**ï¼š

- åŒé‡æ•°æ®æºï¼ˆSO vs JSONï¼‰
- å¯é€‰ç§å­éšæœº
- å®‰å…¨çš„ç´¢å¼•èŒƒå›´é™åˆ¶

---

### ç¤ºä¾‹ 3ï¼šå›¾ç‰‡è·¯å¾„å›é€€åŠ è½½

```csharp
private Sprite LoadSpriteWithFallback(string path)
{
    // 1) å°è¯•åŸå§‹è·¯å¾„
    var sp = Resources.Load<Sprite>(path);
    if (sp != null) return sp;

    // 2) å¦‚æœæœ«å°¾ä¸º _0d æˆ– _dï¼Œå°è¯•å»æ‰/æ·»åŠ å‰å¯¼0
    int us = path.LastIndexOf('_');
    if (us >= 0 && us < path.Length - 1)
    {
        var suffix = path.Substring(us + 1);
        if (int.TryParse(suffix, out var n))
        {
            // æ ¼å¼: xxx_0d â†’ xxx_d
            if (suffix.Length == 2 && suffix[0] == '0')
            {
                var alt = path.Substring(0, us + 1) + n.ToString();
                sp = Resources.Load<Sprite>(alt);
                if (sp != null) return sp;
            }
            // æ ¼å¼: xxx_d â†’ xxx_0d (d < 10)
            else if (suffix.Length == 1 && n < 10)
            {
                var alt = path.Substring(0, us + 1) + "0" + suffix;
                sp = Resources.Load<Sprite>(alt);
                if (sp != null) return sp;
            }
        }
    }

    Debug.LogWarning($"[Newspaper] Sprite not found. Tried: {path} and zero-padding variants.");
    return null;
}
```

**åº”ç”¨åœºæ™¯**ï¼š

- å¤„ç†ä¸ä¸€è‡´çš„èµ„æºå‘½å
- æ”¯æŒ `image_06` å’Œ `image_6` åŒæ ¼å¼
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º

---

### ç¤ºä¾‹ 4ï¼šæ¶ˆæ¯å¹¿æ’­

```csharp
// åœ¨ç¬¬4å¼ æŠ¥çº¸åçš„å›è°ƒä¸­
_animationSequence.InsertCallback(callbackDelay, () =>
{
    // å®ä¾‹åŒ–è§†å›¾
    var parent = dailyMessageParent != null ? dailyMessageParent : transform;
    var view = Instantiate(dailyMessagePrefab, parent);
    view.gameObject.SetActive(true);

    // è·å–éšæœºæ¡ç›®
    var entry = dailyMessagesData.GetRandomEntry(useSeed ? (int?)seed : null);
    if (entry == null) return;

    // åŠ è½½å¹¶è®¾ç½®å›¾ç‰‡
    Sprite sprite = !string.IsNullOrEmpty(entry.imagePath)
        ? LoadSpriteWithFallback(entry.imagePath)
        : null;
    view.SetSprite(sprite);

    // æ‰“å°è°ƒæ•´ä¿¡æ¯ï¼ˆç¤ºä¾‹ï¼š5ä¸ªçŠ¶æ€å¹³å‡åˆ†é…ï¼Œæ¯çŠ¶æ€åˆå§‹20%ï¼‰
    if (entry.adjustments != null)
    {
        foreach (var a in entry.adjustments)
        {
            float before = 20f;
            float after = Mathf.Max(0f, before + a.deltaPercent);
            Debug.Log($"[æ¯æ—¥æ¶ˆæ¯] {entry.id}ã€Š{entry.title}ã€‹| " +
                     $"èº«ä»½:{a.identity} çŠ¶æ€:{a.state} æ€§åˆ«:{a.gender} " +
                     $"NPC:{a.npcId} | è°ƒæ•´å‰å: {before:F1}% â†’ {after:F1}% " +
                     $"(å˜åŒ– {a.deltaPercent:+0.0;-0.0;0.0}%)");
        }
    }

    // å¹¿æ’­æ¶ˆæ¯
    var payload = new DailyMessagesData.DailyMessageApplied
    {
        id = entry.id,
        title = entry.title,
        imagePath = entry.imagePath,
        adjustments = entry.adjustments
    };
    MessageManager.Send(payload);
});
```

**å…³é”®ç‚¹**ï¼š

- åŠ¨æ€å®ä¾‹åŒ–è§†å›¾
- æ‰“å°è°ƒè¯•ä¿¡æ¯
- é€šè¿‡ MessageManager è§£è€¦é€šä¿¡

---

## é…ç½®æŒ‡å—

### 1. JSON æ•°æ®é…ç½®

åœ¨`Resources/DailyMessage/DailyMessages.json`åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```json
{
  "version": 1,
  "messages": [
    {
      "id": "news_001",
      "title": "åŸå¸‚é…’æ°´ç¨ä¸Šæ¶¨",
      "imagePath": "DailyMessage/news_01",
      "adjustments": [
        {
          "identity": "worker",
          "state": "happiness",
          "gender": "any",
          "npcId": "",
          "deltaPercent": -5.0
        },
        {
          "identity": "noble",
          "state": "satisfaction",
          "gender": "any",
          "npcId": "",
          "deltaPercent": 3.0
        }
      ]
    },
    {
      "id": "news_002",
      "title": "æ–°é…’è°±æµè¡Œ",
      "imagePath": "DailyMessage/news_02",
      "adjustments": [
        {
          "identity": "any",
          "state": "curiosity",
          "gender": "any",
          "npcId": "",
          "deltaPercent": 8.0
        }
      ]
    }
  ]
}
```

**å­—æ®µè¯´æ˜**ï¼š

- `version`ï¼šæ•°æ®ç‰ˆæœ¬å·ï¼Œç”¨äºæœªæ¥å‡çº§
- `id`ï¼šå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå»ºè®®ä½¿ç”¨å‰ç¼€
- `title`ï¼šæ ‡é¢˜ï¼Œæ”¯æŒæœ¬åœ°åŒ–
- `imagePath`ï¼šResources è·¯å¾„ï¼ˆæ— æ‰©å±•åï¼‰
- `adjustments`ï¼šçŠ¶æ€è°ƒæ•´æ•°ç»„
  - `identity`ï¼šèº«ä»½ç±»å‹ï¼ˆworker/noble/anyï¼‰
  - `state`ï¼šçŠ¶æ€ç±»å‹ï¼ˆhappiness/health/satisfaction ç­‰ï¼‰
  - `gender`ï¼šæ€§åˆ«ç­›é€‰ï¼ˆmale/female/anyï¼‰
  - `npcId`ï¼šç‰¹å®š NPC IDï¼ˆå¯é€‰ï¼‰
  - `deltaPercent`ï¼šç™¾åˆ†æ¯”å˜åŒ–ï¼ˆæ­£è´Ÿå€¼ï¼‰

---

### 2. ScriptableObject é…ç½®

åˆ›å»º DailyMessagesData èµ„äº§ï¼š

1. å³é”® â†’ Create â†’ TN â†’ DailyMessage â†’ DailyMessagesData
2. é…ç½® JSON è·¯å¾„ï¼š`DailyMessage/DailyMessages`
3. ï¼ˆå¯é€‰ï¼‰ç›´æ¥åœ¨`messagesInSO`ä¸­æ·»åŠ æ•°æ®

**ä¼˜å…ˆçº§**ï¼š

```
messagesInSO (SOç›´æ¥æ•°æ®) > JSONæ–‡ä»¶æ•°æ®
```

---

### 3. åœºæ™¯é…ç½®

åœ¨`2_DayMessageScreen`åœºæ™¯ä¸­ï¼š

```
NewspaperAnimationController (GameObject)
â”œâ”€ Newspaper Images (List)
â”‚  â”œâ”€ Image_01
â”‚  â”œâ”€ Image_02
â”‚  â”œâ”€ Image_03
â”‚  â””â”€ Image_04
â”œâ”€ Daily Message Prefab: [DailyMessageView Prefab]
â”œâ”€ Daily Message Parent: [Canvas Transform]
â”œâ”€ Daily Messages Data: [DailyMessagesData SO]
â””â”€ Settings
   â”œâ”€ Delay Between Pages: 0.3
   â”œâ”€ Fade In Duration: 0.5
   â”œâ”€ Play On Start: true
   â”œâ”€ Enable Daily Message: true
   â”œâ”€ Use Seed: false (æµ‹è¯•æ—¶å¯å¯ç”¨)
   â””â”€ Seed: 12345
```

---

### 4. Prefab é…ç½®

**DailyMessageView Prefab ç»“æ„**ï¼š

```
DailyMessageView (Root)
â””â”€ Image (UI Component)
   â”œâ”€ RectTransform (é…ç½®ä½ç½®å¤§å°)
   â””â”€ Image Component (Spriteæ¸²æŸ“)
```

**å¿…éœ€ç»„ä»¶**ï¼š

- `DailyMessageView`è„šæœ¬
- å¼•ç”¨çš„`Image`ç»„ä»¶

---

## æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–

**ç¼“å­˜æœºåˆ¶**

```csharp
// DailyMessagesDataä¸­çš„ç¼“å­˜
private Root _cache;

public Root Load()
{
    if (_cache != null) return _cache;  // é¿å…é‡å¤åŠ è½½
    // ... åŠ è½½é€»è¾‘
}
```

**å¯¹è±¡æ± ï¼ˆå»ºè®®ï¼‰**

```csharp
// å¦‚æœé¢‘ç¹åˆ›å»ºDailyMessageViewï¼Œè€ƒè™‘ä½¿ç”¨å¯¹è±¡æ± 
// TODO: å®ç°å¯¹è±¡æ± é¿å…GC
```

---

### 2. é”™è¯¯å¤„ç†

**èµ„æºåŠ è½½**

```csharp
// å§‹ç»ˆæ£€æŸ¥null
var ta = Resources.Load<TextAsset>(path);
if (ta == null)
{
    Debug.LogWarning($"TextAsset not found: {path}");
    // å°è¯•å¤‡ç”¨è·¯å¾„æˆ–è¿”å›é»˜è®¤å€¼
}
```

**JSON è§£æ**

```csharp
try
{
    _cache = JsonUtility.FromJson<Root>(ta.text);
}
catch (Exception e)
{
    Debug.LogError($"JSON parse error: {e.Message}");
    _cache = new Root { version = 1, messages = new List<Entry>() };
}
```

---

### 3. è°ƒè¯•æŠ€å·§

**å¯ç”¨ç§å­éšæœº**

```csharp
// åœ¨Inspectorä¸­è®¾ç½®
useSeed = true;
seed = 12345;  // æ¯æ¬¡è¿è¡Œè·å¾—ç›¸åŒç»“æœ
```

**æ—¥å¿—è¾“å‡º**

```csharp
// è¯¦ç»†çš„è°ƒæ•´æ—¥å¿—
Debug.Log($"[æ¯æ—¥æ¶ˆæ¯] {entry.id}ã€Š{entry.title}ã€‹| " +
         $"èº«ä»½:{a.identity} çŠ¶æ€:{a.state} | " +
         $"å˜åŒ–: {a.deltaPercent:+0.0;-0.0;0.0}%");
```

**é¢„è§ˆ JSON æ•°æ®**

```csharp
// åœ¨Load()æ–¹æ³•ä¸­æ·»åŠ é¢„è§ˆ
if (_cache.messages.Count == 0)
{
    string preview = ta.text.Length > 200
        ? ta.text.Substring(0, 200) + "..."
        : ta.text;
    Debug.LogWarning($"Loaded JSON but empty. Preview:\n{preview}");
}
```

## é™„å½•

### A. ä¾èµ–é¡¹

- **DOTween** (v1.x+)ï¼šåŠ¨ç”»å¼•æ“
- **Unity UI** (UGUI)ï¼šUI ç³»ç»Ÿ
- **TextMeshPro** (å¯é€‰)ï¼šæ–‡æœ¬æ¸²æŸ“

### B. ç›¸å…³æ–‡ä»¶è·¯å¾„

```
Assets/
â”œâ”€â”€ Scripts/2_DayMessageScreen/
â”‚   â”œâ”€â”€ DailyMessagesData.cs
â”‚   â”œâ”€â”€ DailyMessageView.cs
â”‚   â””â”€â”€ NewspaperAnimationController.cs
â”œâ”€â”€ Resources/DailyMessage/
â”‚   â”œâ”€â”€ DailyMessages.json
â”‚   â”œâ”€â”€ news_01.png
â”‚   â””â”€â”€ news_02.png
â”œâ”€â”€ Prefabs/
â”‚   â””â”€â”€ DailyMessageView.prefab
â””â”€â”€ Scenes/
    â””â”€â”€ 2_DayMessageScreen.unity
```

### C. æ¶ˆæ¯ç±»å‹å®šä¹‰

```csharp
// æ¸¸æˆä¸­å¯èƒ½çš„èº«ä»½ç±»å‹
public enum Identity
{
    Any,
    Worker,
    Noble,
    Merchant,
    Criminal
}

// å¯èƒ½çš„çŠ¶æ€ç±»å‹
public enum State
{
    Happiness,
    Health,
    Satisfaction,
    Curiosity,
    Stress,
    Wealth
}

// æ€§åˆ«ç±»å‹
public enum Gender
{
    Any,
    Male,
    Female
}
```

---

## æ€»ç»“

æ¯æ—¥ä¿¡æ¯ç³»ç»Ÿæ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **æ•°æ®é©±åŠ¨**ï¼šJSON é…ç½®ä¾¿äºç­–åˆ’è°ƒæ•´  
âœ… **å¯æ‰©å±•æ€§**ï¼šæ¸…æ™°çš„æ¥å£å’Œæ¶ˆæ¯ç³»ç»Ÿ  
âœ… **åŠ¨ç”»æ•ˆæœ**ï¼šæµç•…çš„ DOTween åŠ¨ç”»  
âœ… **å®¹é”™å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶  
âœ… **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†çš„æ—¥å¿—å’Œç§å­éšæœºæ”¯æŒ

è¯¥ç³»ç»Ÿä¸ºæ¸¸æˆçš„æ¯æ—¥äº‹ä»¶æä¾›äº†ç¨³å®šçš„åŸºç¡€ï¼Œå¹¶å¯è½»æ¾æ‰©å±•åˆ°å…¶ä»–ç±»ä¼¼åœºæ™¯ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-15  
**é¡¹ç›®**ï¼šTaberna-Noctis
