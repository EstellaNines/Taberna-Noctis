# 时间系统开发文档

**项目：Taberna Noctis（夜之小酒馆）**  
**版本：v1.0**  
**最后更新：2025-10-03**

---

## 📋 目录

1. [系统概述](#系统概述)
2. [时间线设计](#时间线设计)
3. [游戏时钟系统](#游戏时钟系统)
4. [场景切换机制](#场景切换机制)
5. [数据结构设计](#数据结构设计)
6. [核心脚本架构](#核心脚本架构)
7. [UI 显示组件](#ui显示组件)
8. [消息系统集成](#消息系统集成)
9. [实现清单](#实现清单)
 
---

## 系统概述

### 设计目标

- ✅ 实现完整的昼夜循环（早上 → 下午 → 夜晚 → 新一天）
- ✅ 两场景结构（DayScene + NightScene）
- ✅ 真实时间与游戏时间换算
- ✅ 自动阶段推进与场景切换
- ✅ 支持暂停/继续/存档恢复

### 核心循环流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    游戏一天完整循环                          │
└─────────────────────────────────────────────────────────────┘

    DayScene (白天场景)
    ┌──────────────────────────────────────────────────┐
    │  早上阶段 (Morning)                              │
    │  • 真实时间：3分钟 (180秒)                       │
    │  • 游戏时间：08:00 → 12:00                      │
    │  • 玩家操作：进货备货                            │
    │  • UI面板：StockingPanel                        │
    └──────────────────────────────────────────────────┘
                        ↓ 倒计时归零（自动切换）
    ┌──────────────────────────────────────────────────┐
    │  下午阶段 (Afternoon)                            │
    │  • 真实时间：3分钟 (180秒)                       │
    │  • 游戏时间：14:00 → 18:00                      │
    │  • 玩家操作：研发配方 + 上架菜单                 │
    │  • UI面板：RecipePanel + MenuPanel              │
    └──────────────────────────────────────────────────┘
                        ↓ 完成后显示"开始营业"按钮
                        ↓ 玩家点击确认
                        ↓
                   LoadingScreen
              "第X天 夜晚 即将营业..."
                        ↓
    NightScene (夜晚场景)
    ┌──────────────────────────────────────────────────┐
    │  夜晚阶段 (Night)                                │
    │  • 真实时间：5分钟 (300秒)                       │
    │  • 游戏时间：19:00 → 次日03:00                  │
    │  • 玩家操作：服务顾客，提交饮品卡牌              │
    │  • 顾客生成：每25-35秒随机生成                  │
    └──────────────────────────────────────────────────┘
                        ↓ 倒计时归零
                        ↓
    ┌──────────────────────────────────────────────────┐
    │  结算界面 (DayEndScreen)                         │
    │  • 显示：今日收入、服务人数、平均评分           │
    │  • 判定：是否达到星级标准                        │
    │  • 奖励：星级奖励、特殊配方                      │
    └──────────────────────────────────────────────────┘
                        ↓ 点击"继续新的一天"
                        ↓ Day + 1
                        ↓
                   LoadingScreen
                "第X天 早上 准备中..."
                        ↓
              回到 DayScene (早上阶段)
                  循环继续...
```

---

## 时间线设计

### 时间换算表

| 阶段                 | 真实时长           | 游戏时间范围  | 游戏时长             | 时间流速比                              | 场景       |
| -------------------- | ------------------ | ------------- | -------------------- | --------------------------------------- | ---------- |
| **早上 (Morning)**   | 3 分钟<br>(180 秒) | 08:00 → 12:00 | 4 小时<br>(240 分钟) | 1 真实秒 = 80 游戏秒<br>(1.33 游戏分钟) | DayScene   |
| **下午 (Afternoon)** | 3 分钟<br>(180 秒) | 14:00 → 18:00 | 4 小时<br>(240 分钟) | 1 真实秒 = 80 游戏秒<br>(1.33 游戏分钟) | DayScene   |
| **夜晚 (Night)**     | 5 分钟<br>(300 秒) | 19:00 → 03:00 | 8 小时<br>(480 分钟) | 1 真实秒 = 96 游戏秒<br>(1.6 游戏分钟)  | NightScene |

**总计一天循环**：真实 11 分钟 = 游戏内 16 小时

**跳过时段**：

- 12:00-14:00（午休 2 小时）
- 18:00-19:00（晚餐准备 1 小时）

### 阶段状态机图

```mermaid
stateDiagram-v2
    [*] --> Morning
    Morning --> Afternoon : 180秒倒计时归零<br/>时钟跳转14:00
    Afternoon --> Night : 玩家点击"开始营业"<br/>时钟跳转19:00<br/>切换场景
    Night --> DayEnd : 300秒倒计时归零<br/>时钟显示03:00
    DayEnd --> Morning : 点击"继续新的一天"<br/>Day+1<br/>时钟重置08:00<br/>切换场景

    note right of Morning
        DayScene
        StockingPanel显示
        进货备货操作
    end note

    note right of Afternoon
        DayScene
        RecipePanel显示
        研发配方+上架
    end note

    note right of Night
        NightScene
        吧台场景
        服务顾客
    end note

    note right of DayEnd
        结算界面
        显示收入/评分
        星级判定
    end note
```

### 时间线枚举定义

```csharp
// 主时段枚举
public enum TimePhase
{
    Morning,      // 早上 08:00-12:00
    Afternoon,    // 下午 14:00-18:00
    Night         // 夜晚 19:00-03:00
}

// DayScene内部子阶段
public enum DaySubPhase
{
    MorningStocking,        // 早上-进货备货
    AfternoonRecipe,        // 下午-研发配方
    AfternoonMenu           // 下午-选择上架菜单
}
```

---

## 游戏时钟系统

### 时钟更新逻辑

```
┌─────────────────────────────────────────────────┐
│           GameClock 更新流程                     │
└─────────────────────────────────────────────────┘

每帧 Update():
    ┌────────────────────────────────┐
    │ 累积游戏时间                    │
    │ accumulatedSeconds +=           │
    │   Time.deltaTime * timeScale   │
    └────────────────────────────────┘
             ↓
    ┌────────────────────────────────┐
    │ 转换为游戏分钟                  │
    │ totalMinutes =                  │
    │   accumulatedSeconds / 60       │
    └────────────────────────────────┘
             ↓
    ┌────────────────────────────────┐
    │ 计算时、分                      │
    │ hour = startHour + (min / 60)  │
    │ minute = totalMinutes % 60     │
    └────────────────────────────────┘
             ↓
    ┌────────────────────────────────┐
    │ 处理跨天（夜晚19:00→03:00）     │
    │ if (hour >= 24) hour -= 24     │
    └────────────────────────────────┘
```

### 时钟显示示例

（略）

---

## 附加图表

#### 1）阶段推进（简版）

```mermaid
stateDiagram-v2
  [*] --> Morning
  Morning --> Afternoon: 180s 到时
  Afternoon --> Night: 自动/手动开始营业
  Night --> Settlement: 300s 到时
  Settlement --> Morning: StartNewDay()
```

#### 2）自动保存触发时序

```mermaid
sequenceDiagram
  participant T as TimeSystemManager
  participant S as SaveManager
  loop Update()
    T->>T: 检查 PhaseRemainingTime
    alt Morning 临近结束
      T->>S: SaveCheckpoint()
    else Afternoon 临近结束
      T->>S: SaveBeforeNight()
    else Night 临近结束
      T->>S: SaveAfterNight()
    end
  end
```

#### 3）时间倍率与时钟换算

```mermaid
flowchart LR
  A[真实秒 dt] --> B[* timeScale]
  B --> C[游戏秒 ds]
  C --> D[分钟/小时累计]
  D --> E[Clock(HH:MM)]
  subgraph 比例
    X1[Morning=80]
    X2[Afternoon=80]
    X3[Night=96]
  end
```
